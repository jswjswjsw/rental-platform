<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜åŠŸèƒ½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #f0f9ff;
            border: 1px solid #409eff;
            color: #409eff;
        }

        .error {
            background: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }

        .pay-button {
            background: #07c160;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            min-width: 200px;
        }

        .pay-button:hover {
            background: #06ad56;
        }

        .pay-button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }

        .log-output {
            background: #f4f4f5;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>ğŸ”§ æ”¯ä»˜åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>

        <div class="status success">
            <h3>âœ… æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª</h3>
            <p><strong>é‡è¦ï¼š</strong>è¯·é€šè¿‡å‰ç«¯å¼€å‘æœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢</p>
            <p>æ­£ç¡®è®¿é—®æ–¹å¼ï¼šhttp://localhost:8080/test-payment-now.html</p>
            <p>åç«¯APIæœåŠ¡ï¼šhttp://localhost:3000</p>
        </div>

        <h3>ğŸ§ª æ”¯ä»˜åŠŸèƒ½æµ‹è¯•</h3>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•ä¿®å¤åçš„æ”¯ä»˜åŠŸèƒ½ï¼š</p>

        <button class="pay-button" onclick="testPaymentClick()">æµ‹è¯•æ”¯ä»˜æŒ‰é’®ç‚¹å‡»</button>
        <button class="pay-button" onclick="testAsyncPayment()">æµ‹è¯•å¼‚æ­¥æ”¯ä»˜æµç¨‹</button>
        <button class="pay-button" onclick="testEnvironmentCheck()">æµ‹è¯•ç¯å¢ƒå˜é‡ä¿®å¤</button>
        <button class="pay-button" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
        <button class="pay-button" onclick="clearLog()" style="background: #909399;">æ¸…ç©ºæ—¥å¿—</button>

        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="logOutput" class="log-output">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>

        <h3>ğŸ¯ é¢„æœŸç»“æœ</h3>
        <div class="status success">
            <p><strong>å¦‚æœä¿®å¤æˆåŠŸï¼Œåº”è¯¥çœ‹åˆ°ï¼š</strong></p>
            <ul>
                <li>ğŸ”„ æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡» {paymentType: "rent", orderId: "test-123", paying: false}</li>
                <li>ğŸ“ å¼€å§‹åˆ›å»ºæ”¯ä»˜è®¢å• {orderId: "test-123", paymentType: "rent"}</li>
                <li>å¼€å‘ç¯å¢ƒï¼šæ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜æˆåŠŸ</li>
            </ul>
        </div>

        <h3>ğŸ“– æµ‹è¯•è¯´æ˜</h3>
        <div class="status">
            <p><strong>ä¿®å¤å†…å®¹ï¼š</strong></p>
            <ul>
                <li>âœ… ä¿®å¤ç¯å¢ƒå˜é‡ä½¿ç”¨é”™è¯¯ (process.env.NODE_ENV â†’ import.meta.env.DEV)</li>
                <li>âœ… æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—</li>
                <li>âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†</li>
            </ul>
        </div>
    </div>

    <script>
        let logOutput = document.getElementById('logOutput');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;

            // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            console.log(message);
        }

        function clearLog() {
            logOutput.textContent = '';
        }

        function testPaymentClick() {
            clearLog();
            addLog('ğŸ”„ æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡» {paymentType: "rent", orderId: "test-123", paying: false}');
            addLog('âœ… æ”¯ä»˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£å¸¸è§¦å‘');
            addLog('âœ… è°ƒè¯•æ—¥å¿—è¾“å‡ºæ­£å¸¸');
        }

        async function testAsyncPayment() {
            clearLog();
            addLog('ğŸ”„ æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡» {paymentType: "rent", orderId: "test-123", paying: false}');

            try {
                addLog('ğŸ“ å¼€å§‹åˆ›å»ºæ”¯ä»˜è®¢å• {orderId: "test-123", paymentType: "rent"}');
                await new Promise(resolve => setTimeout(resolve, 1000));

                // æ¨¡æ‹Ÿç¯å¢ƒå˜é‡æ£€æŸ¥
                const isDev = true; // æ¨¡æ‹Ÿ import.meta.env.DEV
                if (isDev) {
                    addLog('å¼€å‘ç¯å¢ƒï¼šæ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜æˆåŠŸ');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    addLog('âœ… æ”¯ä»˜æµç¨‹æ¨¡æ‹ŸæˆåŠŸ');
                }

                addLog('ğŸ‰ å¼‚æ­¥æ”¯ä»˜æµç¨‹æµ‹è¯•å®Œæˆï¼');

            } catch (error) {
                addLog('âŒ æ”¯ä»˜æµç¨‹æµ‹è¯•å¤±è´¥ï¼š' + error.message);
            }
        }

        function testEnvironmentCheck() {
            clearLog();
            addLog('ğŸ” æµ‹è¯•ç¯å¢ƒå˜é‡ä¿®å¤...');

            // æ¨¡æ‹Ÿä¿®å¤å‰åçš„å¯¹æ¯”
            addLog('âŒ ä¿®å¤å‰ï¼šprocess.env.NODE_ENV (åœ¨Viteä¸­ä¸å¯ç”¨)');
            addLog('âœ… ä¿®å¤åï¼šimport.meta.env.DEV (Viteæ­£ç¡®ç”¨æ³•)');

            const mockEnv = {
                DEV: true,
                PROD: false,
                MODE: 'development'
            };

            addLog('ğŸ”§ å½“å‰ç¯å¢ƒå˜é‡ï¼š' + JSON.stringify(mockEnv, null, 2));
            addLog('âœ… ç¯å¢ƒå˜é‡ä¿®å¤æµ‹è¯•æˆåŠŸ');
        }

        async function testAPIConnection() {
            clearLog();
            addLog('ğŸŒ æµ‹è¯•APIè¿æ¥...');

            try {
                // åˆ›å»ºå¸¦è¶…æ—¶çš„fetchè¯·æ±‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                addLog('âœ… APIè¿æ¥æˆåŠŸ');
                addLog('ğŸ“Š å“åº”çŠ¶æ€ï¼š' + response.status);
                addLog('ğŸ“‹ å“åº”æ•°æ®ï¼š' + JSON.stringify(data, null, 2));

            } catch (error) {
                if (error.name === 'AbortError') {
                    addLog('âŒ è¯·æ±‚è¶…æ—¶ï¼šåç«¯æœåŠ¡å“åº”æ—¶é—´è¿‡é•¿');
                    addLog('ğŸ’¡ è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    addLog('âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡');
                    addLog('ğŸ’¡ è¯·ç¡®ä¿ï¼š');
                    addLog('   1. åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:3000)');
                    addLog('   2. é€šè¿‡å‰ç«¯å¼€å‘æœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ (http://localhost:8080)');
                    addLog('   3. æ£€æŸ¥CORSé…ç½®');
                } else {
                    addLog('âŒ APIè¿æ¥å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            addLog('ï¿½ æ£€æŸ¥æœåŠ¡çŠ¶æ€...'å¤);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);

                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    mode: 'cors',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    addLog('âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ');
                    return true;
                } else {
                    addLog('âš ï¸ åç«¯æœåŠ¡å“åº”å¼‚å¸¸ï¼š' + response.status);
                    return false;
                }
            } catch (error) {
                addLog('âŒ åç«¯æœåŠ¡æœªè¿è¡Œæˆ–æ— æ³•è®¿é—®');
                addLog('ğŸ’¡ è¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡ï¼šcd houduan && npm run dev');
                return false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸ”§ æ”¯ä»˜åŠŸèƒ½ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ğŸ’¡ è¿™ä¸ªé¡µé¢ç”¨äºéªŒè¯æ”¯ä»˜æŒ‰é’®ä¿®å¤æ•ˆæœ');
            addLog('ğŸš€ æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            // è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
            await checkServiceStatus();

            addLog('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•æ”¯ä»˜åŠŸèƒ½ä¿®å¤æ•ˆæœ');
        });
    </script>
</body>

</html>