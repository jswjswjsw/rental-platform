import{_ as q,r as u,D as C,o as H,a as P,b as _,c as v,d as t,t as l,e as g,w as B,i as D,z as k,E as h,g as x,p as A,u as F,k as M,a2 as W,F as J,f as L}from"./index-05c20d45.js";const O={name:"WechatPay",props:{order:{type:Object,required:!0},paymentType:{type:String,required:!0,validator:o=>["rent","deposit"].includes(o)}},emits:["success","error"],setup(o,{emit:e}){const i=u(!1),s=u(""),w=u(null),y=u(0),c=()=>{o.paymentType==="rent"?y.value=Math.round(o.order.total_price*100):o.paymentType==="deposit"&&(y.value=Math.round(o.order.deposit*100))},f=C(()=>o.paymentType==="rent"?"ç§Ÿèµè´¹ç”¨":"æŠ¼é‡‘"),T=C(()=>{switch(s.value){case"pending":return"ç­‰å¾…æ”¯ä»˜ä¸­...";case"success":return"æ”¯ä»˜æˆåŠŸï¼";case"failed":return"æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•";case"cancelled":return"æ”¯ä»˜å·²å–æ¶ˆ";default:return""}}),b=C(()=>{switch(s.value){case"pending":return"info";case"success":return"success";case"failed":return"error";case"cancelled":return"warning";default:return"info"}}),S=()=>navigator.userAgent.toLowerCase().includes("micromessenger"),r=async()=>{console.log("ğŸ“ å¼€å§‹åˆ›å»ºæ”¯ä»˜è®¢å•",{orderId:o.order.id,paymentType:o.paymentType});try{const n=S()?"JSAPI":"H5",a=await x.post("/payments/wechat/create",{order_id:o.order.id,payment_type:o.paymentType,trade_type:n,openid:I()});if(a.data.status==="success")return a.data.data;throw new Error(a.data.message)}catch(n){throw console.error("åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥:",n),n}},I=()=>localStorage.getItem("wechat_openid")||"",V=n=>new Promise((a,m)=>{if(typeof window.WeixinJSBridge>"u"){m(new Error("è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€"));return}window.WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:n.appId,timeStamp:n.timeStamp,nonceStr:n.nonceStr,package:n.package,signType:n.signType,paySign:n.paySign},E=>{E.err_msg==="get_brand_wcpay_request:ok"?a(E):E.err_msg==="get_brand_wcpay_request:cancel"?m(new Error("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜")):m(new Error("æ”¯ä»˜å¤±è´¥"))})}),d=n=>{window.location.href=n},p=async n=>{try{const a=await x.get(`/payments/${n}/status`);return a.data.status==="success"?a.data.data.status:"pending"}catch(a){return console.error("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:",a),"failed"}},N=n=>{const a=async()=>{const m=await p(n);s.value=m,m==="success"?(h.success("æ”¯ä»˜æˆåŠŸï¼"),e("success",{paymentId:n,paymentType:o.paymentType})):m==="failed"?(h.error("æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•"),e("error",new Error("æ”¯ä»˜å¤±è´¥"))):m==="pending"&&setTimeout(a,2e3)};a()},z=async()=>{var n;if(console.log("ğŸ”„ æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡»",{paymentType:o.paymentType,orderId:(n=o.order)==null?void 0:n.id,paying:i.value}),i.value){console.log("âš ï¸ æ”¯ä»˜æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»");return}try{i.value=!0,s.value="pending";const a=await r();w.value=a.payment_id,a.trade_type==="JSAPI"?(await V(a.payment_params),N(a.payment_id)):a.trade_type==="H5"&&d(a.payment_params.mweb_url)}catch(a){console.error("æ”¯ä»˜å¤±è´¥:",a),h.error(a.message||"æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•"),s.value="failed",e("error",a)}finally{i.value=!1}};return H(()=>{c()}),{paying:i,paymentStatus:s,amount:y,paymentTypeText:f,statusText:T,statusType:b,handlePay:z}}},R={class:"wechat-pay"},U={class:"payment-info"},G={class:"amount"},K={class:"value"},Q={class:"type"},X={class:"value"},Y={class:"order-info"},Z={class:"value"},j={class:"payment-actions"},$={key:0,class:"payment-status"};function ee(o,e,i,s,w,y){const c=P("el-button"),f=P("el-alert");return _(),v("div",R,[t("div",U,[t("div",G,[e[0]||(e[0]=t("span",{class:"label"},"æ”¯ä»˜é‡‘é¢ï¼š",-1)),t("span",K,"Â¥"+l((s.amount/100).toFixed(2)),1)]),t("div",Q,[e[1]||(e[1]=t("span",{class:"label"},"æ”¯ä»˜ç±»å‹ï¼š",-1)),t("span",X,l(s.paymentTypeText),1)]),t("div",Y,[e[2]||(e[2]=t("span",{class:"label"},"è®¢å•ä¿¡æ¯ï¼š",-1)),t("span",Z,l(i.order.resource_title),1)])]),t("div",j,[g(c,{type:"primary",size:"large",loading:s.paying,onClick:s.handlePay,class:"pay-button"},{default:B(()=>[e[3]||(e[3]=t("i",{class:"el-icon-wallet"},null,-1)),D(" "+l(s.paying?"æ”¯ä»˜ä¸­...":"å¾®ä¿¡æ”¯ä»˜"),1)]),_:1,__:[3]},8,["loading","onClick"])]),s.paymentStatus?(_(),v("div",$,[g(f,{title:s.statusText,type:s.statusType,closable:!1,"show-icon":""},null,8,["title","type"])])):k("",!0)])}const te=q(O,[["render",ee],["__scopeId","data-v-87c9a0a0"]]);const se={name:"Payment",components:{WechatPay:te},setup(){const o=A(),e=F(),i=u(null),s=u("wechat"),w=u("rent"),y=u([]),c=u(!1),f=async()=>{try{const d=o.params.orderId||o.query.orderId;if(!d){h.error("è®¢å•IDä¸èƒ½ä¸ºç©º"),e.push("/orders");return}c.value=!0;const p=await x.get(`/orders/${d}`);p.data.status==="success"?(i.value=p.data.data.order,o.query.type&&(w.value=o.query.type)):(h.error(p.data.message),e.push("/orders"))}catch(d){console.error("è·å–è®¢å•ä¿¡æ¯å¤±è´¥:",d),h.error("è·å–è®¢å•ä¿¡æ¯å¤±è´¥"),e.push("/orders")}finally{c.value=!1}},T=async()=>{try{const d=o.params.orderId||o.query.orderId,p=await x.get("/payments",{params:{order_id:d}});p.data.status==="success"&&(y.value=p.data.data.payments)}catch(d){console.error("è·å–æ”¯ä»˜è®°å½•å¤±è´¥:",d)}},b=()=>{h.success("æ”¯ä»˜æˆåŠŸï¼"),T(),setTimeout(()=>{e.push(`/orders/${i.value.id}`)},3e3)},S=d=>{console.error("æ”¯ä»˜å¤±è´¥:",d),h.error("æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•")},r=d=>{switch(d){case"success":return"success";case"pending":return"warning";case"failed":return"danger";default:return"info"}},I=d=>{switch(d){case"success":return"æ”¯ä»˜æˆåŠŸ";case"pending":return"å¾…æ”¯ä»˜";case"failed":return"æ”¯ä»˜å¤±è´¥";case"cancelled":return"å·²å–æ¶ˆ";default:return"æœªçŸ¥"}},V=d=>new Date(d).toLocaleString();return H(()=>{f(),T()}),{order:i,selectedMethod:s,selectedType:w,paymentHistory:y,loading:c,handlePaymentSuccess:b,handlePaymentError:S,getStatusType:r,getStatusText:I,formatTime:V}}},ae={class:"payment-page"},oe={class:"container"},ne={key:0,class:"order-info"},re={class:"order-details"},de={class:"order-item"},le={class:"value"},ie={class:"order-item"},ce={class:"value"},ue={class:"order-item"},ye={class:"value"},pe={class:"order-item"},me={class:"value"},_e={class:"order-item"},ve={class:"value"},he={class:"order-item total"},fe={class:"value"},ge={class:"order-item total"},we={class:"value"},Te={class:"payment-methods"},be={class:"method-list"},Se={class:"method-radio"},Pe={class:"payment-types"},ke={class:"type-list"},xe={class:"type-info"},Ie={class:"type-amount"},Ve={class:"type-info"},Ee={class:"type-amount"},Ce={key:1,class:"payment-component"},Me={key:2,class:"payment-history"},We={class:"history-list"},qe={class:"payment-info"},He={class:"payment-type"},Be={class:"payment-amount"},De={class:"payment-status"},Ne={class:"payment-time"};function ze(o,e,i,s,w,y){var b,S;const c=P("el-radio"),f=P("WechatPay"),T=P("el-tag");return _(),v("div",ae,[t("div",oe,[e[21]||(e[21]=t("div",{class:"page-header"},[t("h1",null,"è®¢å•æ”¯ä»˜"),t("p",null,"è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼å®Œæˆä»˜æ¬¾")],-1)),s.order?(_(),v("div",ne,[e[13]||(e[13]=t("h2",null,"è®¢å•ä¿¡æ¯",-1)),t("div",re,[t("div",de,[e[6]||(e[6]=t("span",{class:"label"},"è®¢å•å·ï¼š",-1)),t("span",le,l(s.order.order_no),1)]),t("div",ie,[e[7]||(e[7]=t("span",{class:"label"},"èµ„æºåç§°ï¼š",-1)),t("span",ce,l(s.order.resource_title),1)]),t("div",ue,[e[8]||(e[8]=t("span",{class:"label"},"ç§Ÿèµæ—¶é—´ï¼š",-1)),t("span",ye,l(s.order.start_date)+" è‡³ "+l(s.order.end_date),1)]),t("div",pe,[e[9]||(e[9]=t("span",{class:"label"},"ç§Ÿèµå¤©æ•°ï¼š",-1)),t("span",me,l(s.order.days)+"å¤©",1)]),t("div",_e,[e[10]||(e[10]=t("span",{class:"label"},"æ—¥ç§Ÿé‡‘ï¼š",-1)),t("span",ve,"Â¥"+l(s.order.daily_price),1)]),t("div",he,[e[11]||(e[11]=t("span",{class:"label"},"ç§Ÿèµè´¹ç”¨ï¼š",-1)),t("span",fe,"Â¥"+l(s.order.total_price),1)]),t("div",ge,[e[12]||(e[12]=t("span",{class:"label"},"æŠ¼é‡‘ï¼š",-1)),t("span",we,"Â¥"+l(s.order.deposit),1)])])])):k("",!0),t("div",Te,[e[16]||(e[16]=t("h2",null,"æ”¯ä»˜æ–¹å¼",-1)),t("div",be,[t("div",{class:M(["method-item",{active:s.selectedMethod==="wechat"}]),onClick:e[1]||(e[1]=r=>s.selectedMethod="wechat")},[e[14]||(e[14]=W('<div class="method-icon" data-v-14b826d6><i class="el-icon-chat-dot-round" data-v-14b826d6></i></div><div class="method-info" data-v-14b826d6><div class="method-name" data-v-14b826d6>å¾®ä¿¡æ”¯ä»˜</div><div class="method-desc" data-v-14b826d6>å®‰å…¨å¿«æ·ï¼Œæ”¯æŒå¾®ä¿¡é’±åŒ…</div></div>',2)),t("div",Se,[g(c,{modelValue:s.selectedMethod,"onUpdate:modelValue":e[0]||(e[0]=r=>s.selectedMethod=r),label:"wechat"},null,8,["modelValue"])])],2),e[15]||(e[15]=W('<div class="method-item disabled" title="å³å°†å¼€æ”¾" data-v-14b826d6><div class="method-icon" data-v-14b826d6><i class="el-icon-wallet" data-v-14b826d6></i></div><div class="method-info" data-v-14b826d6><div class="method-name" data-v-14b826d6>æ”¯ä»˜å®</div><div class="method-desc" data-v-14b826d6>å³å°†å¼€æ”¾</div></div></div>',1))])]),t("div",Pe,[e[19]||(e[19]=t("h2",null,"æ”¯ä»˜å†…å®¹",-1)),t("div",ke,[t("div",{class:M(["type-item",{active:s.selectedType==="rent"}]),onClick:e[3]||(e[3]=r=>s.selectedType="rent")},[t("div",xe,[e[17]||(e[17]=t("div",{class:"type-name"},"ç§Ÿèµè´¹ç”¨",-1)),t("div",Ie,"Â¥"+l(((b=s.order)==null?void 0:b.total_price)||0),1)]),g(c,{modelValue:s.selectedType,"onUpdate:modelValue":e[2]||(e[2]=r=>s.selectedType=r),label:"rent"},null,8,["modelValue"])],2),t("div",{class:M(["type-item",{active:s.selectedType==="deposit"}]),onClick:e[5]||(e[5]=r=>s.selectedType="deposit")},[t("div",Ve,[e[18]||(e[18]=t("div",{class:"type-name"},"æŠ¼é‡‘",-1)),t("div",Ee,"Â¥"+l(((S=s.order)==null?void 0:S.deposit)||0),1)]),g(c,{modelValue:s.selectedType,"onUpdate:modelValue":e[4]||(e[4]=r=>s.selectedType=r),label:"deposit"},null,8,["modelValue"])],2)])]),s.selectedMethod==="wechat"&&s.order?(_(),v("div",Ce,[g(f,{order:s.order,"payment-type":s.selectedType,onSuccess:s.handlePaymentSuccess,onError:s.handlePaymentError},null,8,["order","payment-type","onSuccess","onError"])])):k("",!0),s.paymentHistory.length>0?(_(),v("div",Me,[e[20]||(e[20]=t("h2",null,"æ”¯ä»˜è®°å½•",-1)),t("div",We,[(_(!0),v(J,null,L(s.paymentHistory,r=>(_(),v("div",{key:r.id,class:"history-item"},[t("div",qe,[t("div",He,l(r.payment_type==="rent"?"ç§Ÿèµè´¹ç”¨":"æŠ¼é‡‘"),1),t("div",Be,"Â¥"+l((r.amount/100).toFixed(2)),1)]),t("div",De,[g(T,{type:s.getStatusType(r.status),size:"small"},{default:B(()=>[D(l(s.getStatusText(r.status)),1)]),_:2},1032,["type"])]),t("div",Ne,l(s.formatTime(r.created_at)),1)]))),128))])])):k("",!0)])])}const Fe=q(se,[["render",ze],["__scopeId","data-v-14b826d6"]]);export{Fe as default};
