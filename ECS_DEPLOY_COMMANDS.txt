# ECSéƒ¨ç½²å‘½ä»¤ - æ”¯ä»˜åŠŸèƒ½ä¿®å¤

## åœ¨ECSæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

# 1. SSHè¿žæŽ¥åˆ°ECS (è¯·æ›¿æ¢ä¸ºå®žé™…IPåœ°å€)
ssh root@YOUR_ECS_IP

# 2. æŸ¥æ‰¾å¹¶è¿›å…¥é¡¹ç›®ç›®å½•
# å¸¸è§ä½ç½®ï¼š/root/rental-platform æˆ– /home/user/rental-platform
find / -name "rental-platform" -type d 2>/dev/null | head -1
cd $(find / -name "rental-platform" -type d 2>/dev/null | head -1)

# æˆ–è€…æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ï¼š
# cd /root/rental-platform

# 3. éªŒè¯å½“å‰ç›®å½•å¹¶æ‹‰å–æœ€æ–°ä»£ç 
pwd
ls -la
git status
git pull origin main

# 4. æ¢å¤é˜¿é‡Œäº‘RDSé…ç½®
cd houduan
if [ -f .env.backup ]; then
    cp .env.backup .env
    echo "âœ… å·²æ¢å¤é˜¿é‡Œäº‘RDSé…ç½®"
else
    echo "âŒ .env.backup æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨é…ç½®.env"
fi

# 5. æ£€æŸ¥å¹¶é‡å¯æœåŠ¡
cd ..

# æ£€æŸ¥PM2æœåŠ¡çŠ¶æ€
pm2 list

# é‡å¯æœåŠ¡ï¼ˆæ ¹æ®å®žé™…æœåŠ¡åè°ƒæ•´ï¼‰
pm2 restart rental-frontend 2>/dev/null || echo "âš ï¸ rental-frontend æœåŠ¡ä¸å­˜åœ¨"
pm2 restart rental-backend 2>/dev/null || echo "âš ï¸ rental-backend æœåŠ¡ä¸å­˜åœ¨"

# 6. éªŒè¯ä¿®å¤æ•ˆæžœ
echo "ðŸ§ª æ”¯ä»˜åŠŸèƒ½æµ‹è¯•æ­¥éª¤ï¼š"
echo "1. è®¿é—® http://YOUR_ECS_IP:8080"
echo "2. æ³¨å†Œ/ç™»å½•ç”¨æˆ·è´¦å·"
echo "3. åˆ›å»ºè®¢å•è¿›å…¥æ”¯ä»˜é¡µé¢"
echo "4. æ‰“å¼€æµè§ˆå™¨F12å¼€å‘è€…å·¥å…·"
echo "5. ç‚¹å‡»æ”¯ä»˜æŒ‰é’®ï¼Œåº”è¯¥çœ‹åˆ°ï¼š"
echo "   ðŸ”„ æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡» {paymentType: \"rent\", orderId: \"xxx\", paying: false}"
echo "   ðŸ“ å¼€å§‹åˆ›å»ºæ”¯ä»˜è®¢å• {orderId: \"xxx\", paymentType: \"rent\"}"

# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
echo "ðŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶..."
[ -f "qianduan/src/components/payment/WechatPay.vue" ] && echo "âœ… WechatPayç»„ä»¶å­˜åœ¨" || echo "âŒ WechatPayç»„ä»¶ç¼ºå¤±"
[ -f "houduan/.env" ] && echo "âœ… åŽç«¯é…ç½®æ–‡ä»¶å­˜åœ¨" || echo "âŒ åŽç«¯é…ç½®æ–‡ä»¶ç¼ºå¤±"

## å¦‚æžœæ²¡æœ‰ä½¿ç”¨PM2ï¼Œæ‰‹åŠ¨é‡å¯ï¼š

# æŸ¥æ‰¾å¹¶åœæ­¢çŽ°æœ‰è¿›ç¨‹
echo "æŸ¥æ‰¾çŽ°æœ‰Node.jsè¿›ç¨‹..."
ps aux | grep -E "(npm|node)" | grep -v grep

# åœæ­¢å‰ç«¯è¿›ç¨‹
pkill -f "npm.*run.*dev" || echo "æ²¡æœ‰æ‰¾åˆ°å‰ç«¯è¿›ç¨‹"
pkill -f "vite" || echo "æ²¡æœ‰æ‰¾åˆ°Viteè¿›ç¨‹"

# é‡æ–°å¯åŠ¨å‰ç«¯ï¼ˆç¡®ä¿logsç›®å½•å­˜åœ¨ï¼‰
mkdir -p logs
cd qianduan
nohup npm run dev > ../logs/frontend.log 2>&1 &
echo "å‰ç«¯æœåŠ¡å·²å¯åŠ¨ï¼ŒPID: $!"

# è¿”å›žæ ¹ç›®å½•
cd ..

## éªŒè¯éƒ¨ç½²æˆåŠŸï¼š
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

echo "æ£€æŸ¥åŽç«¯æœåŠ¡..."
curl -f http://localhost:3000/api/health || echo "âŒ åŽç«¯æœåŠ¡å¼‚å¸¸"

echo "æ£€æŸ¥å‰ç«¯æœåŠ¡..."
curl -f http://localhost:8080 || echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"

echo "æ£€æŸ¥å¤–ç½‘è®¿é—®..."
curl -f http://YOUR_ECS_IP:8080 || echo "âŒ å¤–ç½‘è®¿é—®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™è®¾ç½®"
#
# æ•…éšœæŽ’é™¤ï¼š

### å¦‚æžœgit pullå¤±è´¥ï¼š
```bash
# æ£€æŸ¥GitçŠ¶æ€
git status
git stash  # æš‚å­˜æœ¬åœ°ä¿®æ”¹
git pull origin main
git stash pop  # æ¢å¤æœ¬åœ°ä¿®æ”¹
```

### å¦‚æžœæœåŠ¡å¯åŠ¨å¤±è´¥ï¼š
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :3000
netstat -tlnp | grep :8080

# æ£€æŸ¥Node.jsç‰ˆæœ¬
node --version
npm --version

# æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´
cd houduan && npm install
cd ../qianduan && npm install
```

### å¦‚æžœæ•°æ®åº“è¿žæŽ¥å¤±è´¥ï¼š
```bash
# æµ‹è¯•æ•°æ®åº“è¿žæŽ¥
cd houduan
node -e "
const mysql = require('mysql2');
require('dotenv').config();
const conn = mysql.createConnection({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME
});
conn.connect(err => {
  if (err) console.error('âŒ æ•°æ®åº“è¿žæŽ¥å¤±è´¥:', err.message);
  else console.log('âœ… æ•°æ®åº“è¿žæŽ¥æˆåŠŸ');
  conn.end();
});
"
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š
```bash
# PM2æ—¥å¿—
pm2 logs rental-backend
pm2 logs rental-frontend

# æ‰‹åŠ¨å¯åŠ¨çš„æœåŠ¡æ—¥å¿—
tail -f logs/frontend.log
tail -f logs/backend.log
```

### é‡ç½®æœåŠ¡ï¼ˆç´§æ€¥æƒ…å†µï¼‰ï¼š
```bash
# åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
pm2 stop all
pkill -f node
pkill -f npm

# é‡æ–°å¯åŠ¨
pm2 start ecosystem.config.js
# æˆ–æ‰‹åŠ¨å¯åŠ¨
cd houduan && nohup npm run dev > ../logs/backend.log 2>&1 &
cd qianduan && nohup npm run dev > ../logs/frontend.log 2>&1 &
```