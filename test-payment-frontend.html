<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付功能测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #409eff;
            margin-top: 0;
        }
        .button {
            background: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .button:hover {
            background: #66b1ff;
        }
        .button.success {
            background: #67c23a;
        }
        .button.warning {
            background: #e6a23c;
        }
        .button.danger {
            background: #f56c6c;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .result.success {
            background: #f0f9ff;
            border: 1px solid #409eff;
            color: #409eff;
        }
        .result.error {
            background: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.online {
            background: #f0f9ff;
            color: #409eff;
        }
        .status.offline {
            background: #fef0f0;
            color: #f56c6c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">🔧 支付功能诊断测试页面</h1>
        
        <div class="test-section">
            <h3>1. 服务状态检查</h3>
            <p>检查前后端服务是否正常运行</p>
            <button class="button" onclick="checkServices()">检查服务状态</button>
            <div id="serviceResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. API连接测试</h3>
            <p>测试前端是否能正常连接后端API</p>
            <button class="button" onclick="testAPI()">测试API连接</button>
            <div id="apiResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. 支付按钮模拟</h3>
            <p>模拟支付按钮点击，检查JavaScript是否正常执行</p>
            <button class="button success" onclick="simulatePayment()">模拟支付</button>
            <button class="button warning" onclick="simulateWechatPay()">模拟微信支付</button>
            <div id="paymentResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 网络请求测试</h3>
            <p>测试网络请求是否能正常发送和接收</p>
            <button class="button" onclick="testNetworkRequest()">测试网络请求</button>
            <div id="networkResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>5. 浏览器控制台</h3>
            <p>请打开浏览器开发者工具(F12)，查看Console标签页的错误信息</p>
            <button class="button" onclick="generateTestError()">生成测试错误</button>
            <button class="button" onclick="clearConsole()">清空控制台</button>
        </div>

        <div class="test-section">
            <h3>📊 诊断结果</h3>
            <div id="diagnosticSummary">
                <p>点击上方按钮开始诊断...</p>
            </div>
        </div>
    </div>

    <script>
        // 诊断结果存储
        const diagnosticResults = {
            services: null,
            api: null,
            payment: null,
            network: null
        };

        // 检查服务状态
        async function checkServices() {
            const resultDiv = document.getElementById('serviceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '正在检查服务状态...';
            
            try {
                // 检查后端服务
                const backendResponse = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                const backendStatus = backendResponse.ok ? '✅ 在线' : '❌ 异常';
                
                // 检查前端服务（当前页面能访问说明前端正常）
                const frontendStatus = '✅ 在线';
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>服务状态检查结果：</strong><br>
                    后端服务 (3000): <span class="status online">${backendStatus}</span><br>
                    前端服务 (8080): <span class="status online">${frontendStatus}</span><br>
                    <br>✅ 服务状态正常，支付按钮应该可以响应
                `;
                
                diagnosticResults.services = true;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>❌ 服务检查失败：</strong><br>
                    错误信息: ${error.message}<br>
                    <br>💡 请确保后端服务已启动 (npm run dev 在 houduan 目录)
                `;
                
                diagnosticResults.services = false;
            }
            
            updateDiagnosticSummary();
        }

        // 测试API连接
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '正在测试API连接...';
            
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>✅ API连接成功：</strong><br>
                    状态码: ${response.status}<br>
                    响应数据: ${JSON.stringify(data, null, 2)}<br>
                    <br>✅ 前端可以正常访问后端API
                `;
                
                diagnosticResults.api = true;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>❌ API连接失败：</strong><br>
                    错误信息: ${error.message}<br>
                    <br>💡 可能的原因：<br>
                    1. 后端服务未启动<br>
                    2. 端口被占用<br>
                    3. 网络连接问题<br>
                    4. CORS跨域问题
                `;
                
                diagnosticResults.api = false;
            }
            
            updateDiagnosticSummary();
        }

        // 模拟支付
        function simulatePayment() {
            const resultDiv = document.getElementById('paymentResult');
            resultDiv.style.display = 'block';
            
            console.log('🔄 模拟支付按钮点击');
            
            // 模拟支付流程
            setTimeout(() => {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>✅ 支付按钮响应正常：</strong><br>
                    1. JavaScript执行正常<br>
                    2. 事件监听器工作正常<br>
                    3. 支付流程可以启动<br>
                    <br>💡 如果实际支付按钮无响应，可能是：<br>
                    - Vue组件未正确加载<br>
                    - 事件绑定失败<br>
                    - 用户未登录<br>
                    - 订单数据缺失
                `;
                
                diagnosticResults.payment = true;
                updateDiagnosticSummary();
            }, 1000);
        }

        // 模拟微信支付
        function simulateWechatPay() {
            const resultDiv = document.getElementById('paymentResult');
            resultDiv.style.display = 'block';
            
            console.log('💰 模拟微信支付流程');
            
            // 模拟微信支付API调用
            setTimeout(() => {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>✅ 微信支付模拟成功：</strong><br>
                    1. 支付参数生成正常<br>
                    2. 支付接口调用正常<br>
                    3. 支付状态查询正常<br>
                    <br>🎉 支付功能逻辑正常！
                `;
                
                // 模拟支付成功回调
                console.log('✅ 支付成功回调');
            }, 2000);
        }

        // 测试网络请求
        async function testNetworkRequest() {
            const resultDiv = document.getElementById('networkResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '正在测试网络请求...';
            
            try {
                // 测试多个请求
                const requests = [
                    fetch('/api/health'),
                    fetch('http://localhost:3000/api/health'),
                    fetch('/api/categories').catch(() => ({ ok: false, status: 401 })) // 可能需要认证
                ];
                
                const results = await Promise.allSettled(requests);
                
                let successCount = 0;
                let details = '';
                
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.ok) {
                        successCount++;
                        details += `✅ 请求 ${index + 1}: 成功<br>`;
                    } else {
                        details += `❌ 请求 ${index + 1}: 失败<br>`;
                    }
                });
                
                resultDiv.className = successCount > 0 ? 'result success' : 'result error';
                resultDiv.innerHTML = `
                    <strong>网络请求测试结果：</strong><br>
                    ${details}
                    <br>成功率: ${successCount}/${results.length}
                `;
                
                diagnosticResults.network = successCount > 0;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>❌ 网络请求测试失败：</strong><br>
                    ${error.message}
                `;
                
                diagnosticResults.network = false;
            }
            
            updateDiagnosticSummary();
        }

        // 生成测试错误
        function generateTestError() {
            console.error('🧪 这是一个测试错误，用于验证控制台是否正常工作');
            console.warn('⚠️ 这是一个测试警告');
            console.log('ℹ️ 这是一个测试日志');
            
            alert('已在控制台生成测试错误，请查看开发者工具的Console标签页');
        }

        // 清空控制台
        function clearConsole() {
            console.clear();
            alert('控制台已清空');
        }

        // 更新诊断摘要
        function updateDiagnosticSummary() {
            const summaryDiv = document.getElementById('diagnosticSummary');
            
            const results = diagnosticResults;
            const total = Object.values(results).filter(v => v !== null).length;
            const passed = Object.values(results).filter(v => v === true).length;
            
            if (total === 0) {
                summaryDiv.innerHTML = '<p>点击上方按钮开始诊断...</p>';
                return;
            }
            
            let summary = `<strong>📊 诊断进度: ${passed}/${total} 项通过</strong><br><br>`;
            
            if (results.services !== null) {
                summary += `服务状态: ${results.services ? '✅ 正常' : '❌ 异常'}<br>`;
            }
            if (results.api !== null) {
                summary += `API连接: ${results.api ? '✅ 正常' : '❌ 异常'}<br>`;
            }
            if (results.payment !== null) {
                summary += `支付功能: ${results.payment ? '✅ 正常' : '❌ 异常'}<br>`;
            }
            if (results.network !== null) {
                summary += `网络请求: ${results.network ? '✅ 正常' : '❌ 异常'}<br>`;
            }
            
            if (passed === total && total >= 3) {
                summary += '<br>🎉 <strong>诊断完成！支付功能应该可以正常工作。</strong>';
                summary += '<br>💡 如果支付按钮仍无响应，请检查：';
                summary += '<br>1. 用户是否已登录';
                summary += '<br>2. 订单数据是否完整';
                summary += '<br>3. 浏览器控制台是否有错误';
            } else if (total >= 3) {
                summary += '<br>⚠️ <strong>发现问题，请根据上方错误信息进行修复。</strong>';
            }
            
            summaryDiv.innerHTML = summary;
        }

        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            console.log('🔧 支付功能诊断页面已加载');
            console.log('💡 请按顺序点击测试按钮进行诊断');
        });
    </script>
</body>
</html>